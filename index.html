<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Сканер билетов</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a14;
      --surface: #12121e;
      --accent: #6366f1;
      --accent-dark: #4f46e5;
      --success: #10b981;
      --error: #ef4444;
      --text: #f1f5f9;
      --text-secondary: #94a3b8;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
    }

    header { text-align:center; margin:16px 0 24px; }
    h1 { font-size:2.25rem; font-weight:700; letter-spacing:-0.025em; }
    .event-name { font-size:1.1rem; color:var(--text-secondary); margin-top:4px; }

    #reader-container {
      width:100%; max-width:420px; aspect-ratio:1/1;
      margin:0 auto 24px; border-radius:20px; overflow:hidden;
      box-shadow:0 20px 40px rgba(0,0,0,0.7);
      border:3px solid var(--accent); background:#000;
    }

    #reader { width:100%; height:100%; }

    .status-card {
      width:100%; max-width:460px;
      background:var(--surface); border-radius:16px;
      padding:20px; margin-bottom:20px;
      border:1px solid #1e293b; box-shadow:0 8px 24px rgba(0,0,0,0.4);
    }

    .status-card h3 { color:var(--accent); margin-bottom:12px; font-size:1.25rem; }

    #status { font-size:1.25rem; font-weight:600; min-height:1.6em; line-height:1.4; }

    .success { color:var(--success); }
    .error   { color:var(--error); }

    #result {
      margin-top:12px; padding:12px;
      background:#0f172a; border-radius:10px;
      font-family:monospace; font-size:1.1rem;
      word-break:break-all;
    }

    /* Оверлей "ОТСКАНИРОВАНО" */
    #scan-overlay {
      position:fixed; inset:0;
      background:rgba(0,0,0,0.92);
      display:none; flex-direction:column;
      align-items:center; justify-content:center;
      z-index:1000;
    }

    #scan-overlay.show { display:flex; }

    .scan-text {
      font-size:4.2rem;
      font-weight:900;
      color:var(--success);
      margin-bottom:16px;
      text-shadow:0 0 40px var(--success);
      letter-spacing:0.05em;
    }

    .scan-details {
      font-size:1.5rem;
      color:#e2e8f0;
      text-align:center;
      max-width:85%;
      line-height:1.4;
    }

    .scan-time { font-size:1.1rem; color:var(--text-secondary); margin-top:12px; }

    .btn {
      background:var(--accent); color:white; border:none;
      padding:14px 32px; font-size:1.1rem; font-weight:600;
      border-radius:12px; cursor:pointer;
      margin:12px 8px 0; transition:all 0.18s;
    }

    .btn:hover { background:var(--accent-dark); transform:translateY(-2px); }

    .secondary-btn { background:#334155; margin-top:20px; }
    .secondary-btn:hover { background:#475569; }

    /* Архив */
    #archive {
      width:100%; max-width:460px;
      margin-top:32px;
      background:var(--surface);
      border-radius:16px;
      padding:16px;
      border:1px solid #1e293b;
    }

    #archive h3 { color:var(--accent); font-size:1.2rem; margin-bottom:12px; }

    .archive-list {
      max-height:300px;
      overflow-y:auto;
      font-size:0.95rem;
      line-height:1.6;
    }

    .archive-item {
      padding:8px 0;
      border-bottom:1px solid #2d3748;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }

    .archive-time { color:var(--text-secondary); font-size:0.85rem; white-space:nowrap; }
    .archive-code { font-family:monospace; flex:1; word-break:break-all; }
    .archive-status { font-weight:600; min-width:100px; text-align:right; }

    footer {
      margin-top:auto; padding:32px 0 16px;
      color:#475569; font-size:0.9rem; text-align:center;
    }

    @media (max-width:480px) {
      h1 { font-size:1.9rem; }
      .scan-text { font-size:3.2rem; }
      .scan-details { font-size:1.3rem; }
    }
  </style>
</head>
<body>

  <header>
    <h1>Сканер билетов</h1>
    <div class="event-name">Контроль доступа</div>
  </header>

  <div id="reader-container">
    <div id="reader"></div>
  </div>

  <div class="status-card">
    <h3>Статус</h3>
    <div id="status">Запускаю камеру...</div>
    <div id="result" style="margin-top:12px;">—</div>
  </div>

  <button class="btn secondary-btn" onclick="document.getElementById('fileInput').click()">
    Ручной ввод / фото билета
  </button>

  <input type="file" id="fileInput" accept="image/*" style="display:none;">

  <!-- Оверлей "ОТСКАНИРОВАНО" -->
  <div id="scan-overlay">
    <div class="scan-text">ОТСКАНИРОВАНО</div>
    <div class="scan-details" id="scan-details">Билет принят</div>
    <div class="scan-time" id="scan-time"></div>
  </div>

  <!-- Архив -->
  <div id="archive">
    <h3>Последние 20 сканирований</h3>
    <div class="archive-list" id="archive-list"></div>
  </div>

  <footer>Контроль доступа • Работает только по HTTPS</footer>

  <script src="https://unpkg.com/html5-qrcode@latest/html5-qrcode.min.js"></script>

  <script>
    const WEBHOOK_URL = "https://unsuperciliously-feelingful-kandi.ngrok-free.dev/webhook/v1/scanner";
    const COOLDOWN_MS = 4000;
    const MAX_ARCHIVE = 20;
    const MAX_RECENT_CODES = 5; // сколько последних кодов помнить, чтобы не дублировать

    const statusEl     = document.getElementById("status");
    const resultEl     = document.getElementById("result");
    const scanOverlay  = document.getElementById("scan-overlay");
    const scanDetails  = document.getElementById("scan-details");
    const scanTime     = document.getElementById("scan-time");
    const archiveList  = document.getElementById("archive-list");
    const fileInput    = document.getElementById("fileInput");

    let isCooldown = false;
    let archive = JSON.parse(localStorage.getItem("ticketArchive") || "[]");
    let recentCodes = new Set(); // последние уникальные коды для анти-дубликатов

    function saveArchive() {
      localStorage.setItem("ticketArchive", JSON.stringify(archive.slice(-MAX_ARCHIVE)));
      renderArchive();
    }

    function renderArchive() {
      archiveList.innerHTML = "";
      archive.slice(-MAX_ARCHIVE).reverse().forEach(item => {
        const div = document.createElement("div");
        div.className = "archive-item";
        div.innerHTML = `
          <span class="archive-time">${new Date(item.time).toLocaleTimeString()}</span>
          <span class="archive-code">${item.code.slice(0,12)}${item.code.length > 12 ? '...' : ''}</span>
          <span class="archive-status ${item.status === 'success' ? 'success' : 'error'}">
            ${item.status === 'success' ? 'Принят' : item.message || 'Отклонён'}
          </span>
        `;
        archiveList.appendChild(div);
      });
    }

    renderArchive();

    function setStatus(text, cls = "") {
      statusEl.textContent = text;
      statusEl.className = cls;
    }

    function setResult(text, cls = "") {
      resultEl.textContent = text;
      resultEl.className = cls;
    }

    function addToArchive(code, status, message = "") {
      archive.push({
        time: Date.now(),
        code,
        status,
        message: message || (status === 'success' ? 'Принят' : 'Отклонён')
      });
      saveArchive();
    }

    function isDuplicate(code) {
      return recentCodes.has(code);
    }

    function addToRecent(code) {
      recentCodes.add(code);
      if (recentCodes.size > MAX_RECENT_CODES) {
        // удаляем самый старый (Set не сохраняет порядок, но для 5 элементов не критично)
        const oldest = [...recentCodes][0];
        recentCodes.delete(oldest);
      }
    }

    function showScanSuccess(category = "") {
      const now = new Date().toLocaleString('ru-RU', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });

      scanDetails.textContent = category ? `Принят (${category})` : "Билет принят";
      scanTime.textContent = `Время: ${now}`;
      scanOverlay.classList.add("show");

      new Audio("https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-286.mp3").play().catch(()=>{});
      navigator.vibrate?.(200);

      setTimeout(() => {
        scanOverlay.classList.remove("show");
      }, COOLDOWN_MS);
    }

    function showError(message = "Ошибка проверки билета") {
      setStatus(message.toUpperCase(), "error");
      setResult(message, "error");
      new Audio("https://assets.mixkit.co/sfx/preview/mixkit-negative-answer-low-tone-2033.mp3").play().catch(()=>{});
      navigator.vibrate?.([100, 50, 100]);
    }

    function startCooldown() {
      if (isCooldown) return;
      isCooldown = true;
      setTimeout(() => {
        isCooldown = false;
        setStatus("Готов сканировать следующий билет", "success");
        setResult("—");
      }, COOLDOWN_MS);
    }

    const qrCode = new Html5Qrcode("reader");

    qrCode.start(
      { facingMode: "environment" },
      {
        fps: 15,
        qrbox: function(w, h) { const min = Math.min(w, h); return { width: Math.round(min * 0.78), height: Math.round(min * 0.78) }; },
        aspectRatio: 1.0,
        disableFlip: false
      },
      async (decodedText) => {
        if (isCooldown) return;

        const code = decodedText.trim();

        // Проверка на дубликат
        if (isDuplicate(code)) {
          setStatus("Этот билет уже отсканирован недавно", "warning");
          setResult(code, "warning");
          return; // не отправляем запрос, не добавляем в архив
        }

        setResult(code, "success");
        setStatus("Проверка билета...", "success");

        try {
          const payload = {
            ticket_code: code,
            timestamp: new Date().toISOString(),
            device: navigator.userAgent,
            scanner_id: "scanner-01"
          };

          const res = await fetch(WEBHOOK_URL, {
            method: "POST",
            mode: "cors",
            cache: "no-cache",
            headers: {
              "Content-Type": "application/json",
              "ngrok-skip-browser-warning": "scanner-2026",
              "Accept": "application/json"
            },
            body: JSON.stringify(payload)
          });

          const text = await res.text();
          let data = {};
          try {
            data = JSON.parse(text);
          } catch {
            data = { message: text.trim() };
          }

          let message = data.message || data.errorMessage || data.error || text.trim() || "Неизвестный ответ";
          let category = data.category || "";

          // Обработка конкретных ответов
          if (message.toLowerCase().includes("succesful") || message.toLowerCase().includes("successful")) {
            showScanSuccess(category);
            addToArchive(code, "success", category ? `Принят (${category})` : "Принят");
            setResult(category ? `Принят (${category})` : "Билет принят", "success");
            addToRecent(code); // добавляем в анти-дубликаты только при успехе
          } else {
            let errMsg = message;
            if (message.includes("not exits")) errMsg = "БИЛЕТА НЕ СУЩЕСТВУЕТ!";
            if (message.includes("not correct day")) errMsg = "НЕВЕРНЫЙ ДЕНЬ!";
            if (message.includes("already scanned")) errMsg = "БИЛЕТ УЖЕ ОТМЕЧЕН!";

            showError(errMsg);
            addToArchive(code, "error", errMsg);
            setResult(errMsg, "error");
          }
        } catch (err) {
          showError("Нет связи с сервером");
          addToArchive(code, "error", "Нет связи");
          setResult("Проверьте интернет", "error");
        }

        startCooldown();
      },
      () => {}
    ).catch(err => {
      setStatus("Не удалось открыть камеру", "error");
      setResult(err.message || "Разрешите доступ к камере", "error");
    });

    // Ручная загрузка фото
    fileInput.addEventListener("change", async e => {
      const file = e.target.files[0];
      if (!file) return;

      setStatus("Читаю билет из фото...", "warning");

      try {
        const result = await qrCode.scanFile(file, true);
        const code = result.trim();
        setResult(code, "success");

        // Имитация запроса (можно заменить на реальный fetch)
        showScanSuccess();
        addToArchive(code, "success", "Принят из фото");
        addToRecent(code);
        startCooldown();
      } catch (err) {
        showError("Фото не распознано");
        setResult("Попробуйте другое фото", "error");
      }

      e.target.value = "";
    });
  </script>
</body>
</html>
